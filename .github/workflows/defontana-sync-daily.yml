name: Sincronizaci√≥n Diaria Defontana

on:
  # Ejecutar todos los d√≠as a las 2 AM (hora Chile UTC-3)
  schedule:
    - cron: '0 5 * * *'  # 5 AM UTC = 2 AM Chile

  # Permitir ejecuci√≥n manual desde GitHub
  workflow_dispatch:
    inputs:
      days_back:
        description: 'D√≠as hacia atr√°s para sincronizar'
        required: false
        default: '1'
        type: string

jobs:
  sync-defontana-sales:
    runs-on: ubuntu-latest

    steps:
      - name: üìÖ Calcular fechas
        id: dates
        run: |
          # Calcular fecha de inicio (d√≠as hacia atr√°s)
          DAYS_BACK=${{ github.event.inputs.days_back || '1' }}
          START_DATE=$(date -u -d "$DAYS_BACK days ago" +%Y-%m-%d)
          END_DATE=$(date -u -d "1 day ago" +%Y-%m-%d)

          echo "start_date=$START_DATE" >> $GITHUB_OUTPUT
          echo "end_date=$END_DATE" >> $GITHUB_OUTPUT

          echo "üìÖ Sincronizando desde $START_DATE hasta $END_DATE"

      - name: üîê Obtener token de autenticaci√≥n
        id: auth
        run: |
          # Autenticar con Supabase para obtener token
          AUTH_RESPONSE=$(curl -s -X POST "${{ secrets.SUPABASE_URL }}/auth/v1/token?grant_type=password" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "email": "${{ secrets.SYNC_USER_EMAIL }}",
              "password": "${{ secrets.SYNC_USER_PASSWORD }}"
            }')

          TOKEN=$(echo $AUTH_RESPONSE | jq -r '.access_token')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "‚ùå Error: No se pudo obtener token de autenticaci√≥n"
            echo "Response: $AUTH_RESPONSE"
            exit 1
          fi

          echo "‚úÖ Token obtenido correctamente"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: üîÑ Sincronizar ventas desde Defontana
        id: sync
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.NETLIFY_SITE_URL }}/.netlify/functions/defontana-sync" \
            -H "Authorization: Bearer ${{ steps.auth.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "dateFrom": "${{ steps.dates.outputs.start_date }}",
              "dateTo": "${{ steps.dates.outputs.end_date }}"
            }')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "üìä Respuesta HTTP: $HTTP_CODE"
          echo "üìÑ Body: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Error en sincronizaci√≥n (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi

          # Extraer informaci√≥n del resultado
          SUCCESS=$(echo $BODY | jq -r '.success')
          SALES_IMPORTED=$(echo $BODY | jq -r '.salesImported')
          DOCUMENTS=$(echo $BODY | jq -r '.documentsProcessed')
          SKUS=$(echo $BODY | jq -r '.skusUpdated')
          TIME=$(echo $BODY | jq -r '.timeElapsed')

          echo "‚úÖ Sincronizaci√≥n exitosa"
          echo "üì¶ $DOCUMENTS documentos procesados"
          echo "üìã $SALES_IMPORTED l√≠neas de venta importadas"
          echo "üè∑Ô∏è  $SKUS SKUs actualizados"
          echo "‚è±Ô∏è  Tiempo: $TIME"

          # Guardar m√©tricas para el summary
          echo "sales_imported=$SALES_IMPORTED" >> $GITHUB_OUTPUT
          echo "documents=$DOCUMENTS" >> $GITHUB_OUTPUT
          echo "skus=$SKUS" >> $GITHUB_OUTPUT
          echo "time=$TIME" >> $GITHUB_OUTPUT

      - name: üìä Crear resumen
        if: always()
        run: |
          echo "## üîÑ Sincronizaci√≥n Defontana" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üìÖ Per√≠odo:** ${{ steps.dates.outputs.start_date }} ‚Üí ${{ steps.dates.outputs.end_date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.sync.outcome }}" = "success" ]; then
            echo "‚úÖ **Estado:** Exitoso" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Resultados" >> $GITHUB_STEP_SUMMARY
            echo "- üì¶ Documentos procesados: **${{ steps.sync.outputs.documents }}**" >> $GITHUB_STEP_SUMMARY
            echo "- üìã L√≠neas de venta: **${{ steps.sync.outputs.sales_imported }}**" >> $GITHUB_STEP_SUMMARY
            echo "- üè∑Ô∏è  SKUs actualizados: **${{ steps.sync.outputs.skus }}**" >> $GITHUB_STEP_SUMMARY
            echo "- ‚è±Ô∏è  Tiempo: **${{ steps.sync.outputs.time }}**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Estado:** Error" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Revisa los logs arriba para m√°s detalles." >> $GITHUB_STEP_SUMMARY
          fi

      - name: üìß Notificar si hay error
        if: failure()
        run: |
          echo "‚ùå La sincronizaci√≥n fall√≥"
          echo "Revisa los logs en: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
